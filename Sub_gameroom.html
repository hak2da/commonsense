<!DOCTYPE html>
<html>
<head>


<!-- Animate.css -->
<link rel="stylesheet" href="css/animate.css">
<!-- Icomoon Icon Fonts-->
<link rel="stylesheet" href="css/icomoon.css">
<!-- Bootstrap  -->
<link rel="stylesheet" href="css/bootstrap.css">

<!-- Theme style  -->
<link rel="stylesheet" href="css/bootstrapmin.css">

<link rel="stylesheet" href="css/Main_page/react_button.css">

<link rel="stylesheet" href="css/common/react_style.css">

<!-- commonsense common.css -->
<link rel="stylesheet" href="css/common/common.css">

<!-- commonsense sub_gameroom.css -->
<link rel="stylesheet" href="css/sub_gameroom/Sub_gameroom.css">

<!-- jQuery -->
<script src="js/jquery.min.js"></script>
<!-- jQuery Easing -->
<script src="js/jquery.easing.1.3.js"></script>
<!-- Bootstrap -->
<script src="js/bootstrap.min.js"></script>
<!-- Waypoints -->
<script src="js/jquery.waypoints.min.js"></script>
<!-- Main -->
<script src="js/main.js"></script>
<!-- The core Firebase JS SDK is always required and must be listed first -->
<script src="https://www.gstatic.com/firebasejs/7.16.0/firebase-app.js"></script>

<!-- include firebase database -->
<script
	src="https://www.gstatic.com/firebasejs/7.16.0/firebase-database.js"></script>

<!-- include commonsense firebase reference javascript -->
<script src="js/firebase_initiate/firebase_initiate.js"></script>

<meta charset="UTF-8">
<title>Insert title here</title>
</head>
<body>
	<div id="wrapper">
		<div id="menu-wrapper" style="height: 100px;">
			<div class="head-left">
				<a href="Main_lobby.html"> <img
					src="img/Main_page/brain-physical-tp2.png"
					style="width: 80%; margin-bottom: 3%;" />
				</a>
			</div>
			<div class="head-right">
				<div style="margin-top: 5%;">
					<font id="right_usernick"></font>
				</div>
			</div>
		</div>
		<div>
			<div id="adleft" class="adleft"></div>
			<div style="width: 60%; float: left">
				<div style="height: 10%;">
					<button id="room_settingtool" onclick="makeroom_roomsetting()"
						class="settingtool"
						style="margin-left: 1.2%; visibility: hidden; background-image: url( 'img/sub_gameroom/setting.svg' );">

					</button>
				</div>
				<div id="RoomListBox" class="RoomListBox Product"
					style="position: relative; background-color: white;">

					<div style="width: 100%; height: 390px;">
						<div class="product-title room-name" id="gameroom-title"></div>

						<button onclick="gotowait()" class="product-title goout-button">나가기</button>

						<button onclick="showanddissapear()" class="product-title "
							style="width: 2%; border-top: 0px; border-left: 0.5px solid black; border-radius: 0px 5px 5px 0px; outline: 0px;">1</button>

						<div class="product-body content-box">
							<div style="height: 65%; width: 100%;; position: relative;">

								<div class="content-genre" id="content-genre"></div>

								<div class="content-quiz" id="content-quiz"></div>

								<div id="limit-timebox" class="limit-timebox">
									<div class="limit-time-leftbox">
										<img style="width: 100%; height: 100%;"
											src="img/sub_gameroom/time_limit.png">
									</div>
									<div id="limit-time-rightbox" class="limit-time-rightbox"></div>
								</div>

								<div id="sysmsg" class="sysmsg">
									<div class="sysmsg-border">
										<div class="sysmsg-fontbox">
											<font id="sysmsg-alertcontent" class="sysmsg-alertcontent"></font>
											<font id="sysmsg-whtisans" class="sysmsg-whtisans"></font>
										</div>
									</div>
								</div>

							</div>
							<div style="height: 35%; width: 100%; background-color: none;">
								<span id="ingame_userlist"></span>
								<!-- 레드매실로 작업 -->
								<!-- 								<div class="user-box"> -->
								<!-- 									<img src="img/sub_gameroom/user.png" class="user-img"> -->
								<!-- 									<div class="user-nick">master_011</div> -->
								<!-- 									<div id="-MFwiMzJAJmYmT11QSID-talkballon1" -->
								<!-- 										class="sub display-none" style="display: none;">master_011 -->
								<!-- 										: ㅁㄴㄹㅇ</div> -->
								<!-- 									<img src="img/sub_gameroom/crown.png" class="user-crown"> -->
								<!-- 								</div> -->
							</div>

						</div>
					</div>
					<div style="width: 100%; height: 230px;">
						<div style="width: 80%; height: 100%;">

							<div class="product-title">채팅</div>
							<div id="chat-item-box" class="product-body" style="height: 75%;">

								<div class="chat-item" id="chat-item"></div>

							</div>
							<input id="usermsg_inputbox" class="usermsg_inputbox"
								onkeyup="enterkey();" maxlength="200" autocomplete="off">
							<!-- 					<button class="waitroom" onclick="showanddissapear_sub();" >전송</button> -->
							<button class="gameroom_sendbutton" onclick="userchatting();">전송</button>

						</div>
						<div id="usrready_button_div" style="width: 20%; height: 100%;">
							<!-- 							<button id="usrready_button" onclick="user_ready()" class="ready-button">준비</button> -->
						</div>
					</div>
				</div>
			</div>
			<div id="adright" style="width: 20%; height: 500px; float: left">
			</div>
		</div>
	</div>



	<!-- Modal -->
	<!-- 게임멤버관리 -->
	<div class="modal fade" id="manage_member_modal" role="dialog">
		<div class="modal-dialog">

			<!-- Modal content-->
			<div
				style="width: 400px; margin-left: 40%; margin-top: 8%; vertical-align: middle;"
				class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal">&times;</button>
					<h3 style="font-weight: bold; text-align: center;"
						class="modal-title">멤버 관리</h3>
				</div>
				<div class="modal-body" style="width: 100%; text-align: center;">
					<span id="manage_btn_content"></span>
					<!--           	<button type="button" class="btn btn-default  modal-mr" data-dismiss="modal" >방장 위임</button> -->
					<!--         	<button type="button" class="btn btn-default  modal-ml" data-dismiss="modal" >강퇴</button> -->

				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">취소</button>
				</div>
			</div>

		</div>
	</div>
	<!-- Modal -->
	<!-- 방만들기 설정값 -->
	<div class="modal fade" id="roomSetting" role="dialog">
		<div class="modal-dialog">

			<!-- Modal content-->
			<div
				style="width: 400px; margin-left: 40%; margin-top: 8%; vertical-align: middle;"
				class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal">&times;</button>
					<h3 style="font-weight: bold; text-align: center;"
						class="modal-title">방 설정</h3>
				</div>
				<div class="modal-body">

					제목 <input id="modal_roomname" type="text" value="" maxlength="10">

					<br>
					<br> 게임 인원 &nbsp; <select name="member"
						id="modal_limitofmember">
						<option value="4">4</option>
						<option value="5">5</option>
						<option value="6">6</option>
						<option value="7">7</option>
						<option value="8">8</option>
					</select> <br>
					<br> 게임 라운드 &nbsp; <select name="round" id="modal_gameround">
						<option value="3">3</option>
						<option value="5">5</option>
						<option value="7">7</option>
					</select> <br>
					<br> 제한 시간 &nbsp; <select name="time" id="modal_limitoftime">
						<option value="5">5</option>
						<option value="7">7</option>
						<option value="9">9</option>
					</select>

					<!-- 				<br><br> -->
					<!-- 				<input type="radio" name="group" checked="">개인전 -->
					<!-- 				<input type="radio" name="group">팀전 -->

					<br>
					<br> <input type="checkbox" name="chk_info" value="HTML"
						id="makeroom_lockvalue">잠금설정 <input type="text" value=""
						placeholder="Enter password..." id="makeroom_lockpassword">

					<br>
					<br>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default"
						onclick="gameroomsetting()">확인</button>
					<button type="button" class="btn btn-default" data-dismiss="modal">취소</button>
				</div>
			</div>

		</div>
	</div>


</body>
<script>
	'use strict';
	
	function gotowait(){
		location.href="Sub_waitingroom.html";
	}
	
	function showanddissapear(){
// 		$("#sysmsg").text("123");
// 		$("#sysmsg").css("display","inline");
// 		$("#sysmsg").fadeIn();
		$("#sysmsg").css("visibility","visible");
// 		setTimeout(function(){$("#sysmsg").fadeOut()},1000);
		setTimeout(function(){$("#sysmsg").css("visibility","hidden")},1000);
	}
	
	function showanddissapear_sub(){
		$("#sub_red1").text("123");
		$("#sub_red1").css("display","inline");
		$("#sub_red1").fadeIn();
		setTimeout(function(){$("#sub_red1").fadeOut()},1000);
	}

</script>

<script>
'use strict';
//<<<<<<<<<<<<		firebase	<<<<<<<<<<<<<<<<<
//<<<<<<<<<<<<		firebase	<<<<<<<<<<<<<<<<<
//<<<<<<<<<<<<		firebase	<<<<<<<<<<<<<<<<<
//<<<<<<<<<<<<		firebase	<<<<<<<<<<<<<<<<<
//default setting,variable declare start


//gamehost:방장
var roomid,userid,user_nick,gamestatus=false,gamehost_isme=false,gamehostid,kickout=false;
var anstry_Interval;
var userlist;
var userreadycount;
var userStatusDatabaseRef;
var user_readybool = false;

var userstatusRef;
var userstatusRef_key;//게임룸에 데이터넣을때 user key값

var answer_arr;//게임에서 정답배열을 저장할 객체
var quizgenre_arr= new Array();

window.onload = function(){
	//window onload start
	roomid = localStorage.getItem('roomid');
  	userid = localStorage.getItem('userid');
  	user_nick = localStorage.getItem('usernick');
  	
  	$("#right_usernick").text(user_nick+"님 환영합니다!");
  	
  	if(roomid==null||userid==null||user_nick==null){
		 alert("사용자 데이터가 없습니다.");
		 kickout=true;
		 location.href="Sub_waitingroom.html";
 	}
  	
  //default setting,variable declare end	
}

</script>


<script>
//connect status related javascript start
	 
	var connectstatus_winonload = window.onload;
	window.onload = function(){
		connectstatus_winonload();//window onload를 여러번 사용하기 위함
		// Create a reference to this user's specific status node.
		// This is where we will store data about being online/offline.
	  
		userstatusRef = firebase.database().ref('/rooms/' + roomid+'/users').push({});
		localStorage.setItem("userstatusRef_key",	userstatusRef.key);
		userstatusRef_key = userstatusRef.key;
		
		userStatusDatabaseRef = firebase.database().ref('/rooms/' + roomid+'/users/'+userstatusRef.key);
		
		var isOfflineForDatabase = {
//	 		  status: 'member',
//	 	      ready: false,
//	 	      user_id : userid,
//	 	      user_nick : user_nick,
//	 	      connect_time: firebase.database.ServerValue.TIMESTAMP
 		};
		 
		var isOnlineForDatabase = {
		    status: 'member',
		    ready: false,
		    user_id : userid,
		    user_nick : user_nick,
		    connect_time: firebase.database.ServerValue.TIMESTAMP
		};
		
		firebase.database().ref('.info/connected').on('value', function(snapshot) {
		    // If we're not currently connected, don't do anything.
		    if (snapshot.val() == false) {
		        return;
		    };
		
			userStatusDatabaseRef.onDisconnect().set(isOfflineForDatabase).then(function() {
		
		        var statusRef = userStatusDatabaseRef.set(isOnlineForDatabase);
		    });
		});
		// [END rtdb_presence]		
	}	
	
//connect status related javascript end
</script>

<script>
//common javascript start
	async function gethostid(){
	  	var value;
	 	await firebase.database().ref('/rooms/'+ roomid+'/setting/gamehostid').once('value').then(function(snapshot){
			value =snapshot.val();
		});
	 	return value;
	}
	
	function replaceAll(str, searchStr, replaceStr) {
		   return str.split(searchStr).join(replaceStr);
	}
//common javascript end
</script>

<script>
//user_managing related javascript start
//ingame user handler
	var user_manage_winonload = window.onload;	
	window.onload = function(){
		user_manage_winonload();//window onload를 여러번 사용하기 위함
	   	//방장이 강퇴시 나가게 되는 메서드 리스너
		firebase.database().ref("rooms/"+roomid+"/users/"+userstatusRef.key+"/status").on("value",async function(snapshot){
			 if(snapshot.val()==="kick_out"){
			  kickout="true";
			  alert("강퇴당하셨습니다.");
			  await localStorage.removeItem('roomid');
			  location.href="Sub_waitingroom.html";
			 }
		});	
	}
	
	async function delegate_gamehost(userid){
		  
		//방장권한이고 alert창에서 확인을 눌렀을때
		if(!gamehost_isme || confirm("방장을 위임하시겠습니까?")==false) return;
		 
		await firebase.database().ref('rooms/'+roomid+'/setting').update({
			gamehostid : userid
		});
			 
		await firebase.database().ref('rooms/'+roomid+'/users/'+userstatusRef_key).update({
			status : "member"
		});
		  
	}
	async function kickout_member(user_id,user_nick,user_key){
	  
	  //방장권한이고 alert창에서 확인을 눌렀을때
	  if(!gamehost_isme || confirm("'"+user_nick+"' 멤버를 추방시키겠습니까?")==false) return;
	  
	 	 await firebase.database().ref('rooms/'+roomid+'/users/'+user_key).update({
			status : "kick_out"
		 }); 		  
  	}
 	
	async function get_kickout_val(){
		var kickout;
		firebase.database().ref("rooms/"+roomid+"/users/"+userstatusRef.key+"/status").on("value",function(snapshot){
		 	kickout = snapshot.val()=="kick_out" ? true : false;
		});
		return kickout
	}
   
	function manage_member(nick,id,key){
		if(!gamehost_isme)return;
		$("#manage_btn_content").html("");
		var mng_btn_content = "";
		mng_btn_content += "<button type=\"button\" class=\"btn btn-default  modal-mr\" data-dismiss=\"modal\" ";
		mng_btn_content +="onclick=\"delegate_gamehost('"+id+"')\">방장 위임</button>";
		mng_btn_content +="<button type=\"button\" class=\"btn btn-default  modal-ml\" data-dismiss=\"modal\" ";
		mng_btn_content +=" onclick=\"kickout_member('"+id+"','"+nick+"','"+key+"')\">강퇴</button>";
		$("#manage_btn_content").append(mng_btn_content);
		$("#manage_member_modal").modal();
	}
	  
//user_managing related javascript end
</script>

<script>
//userlist related javascript start

	var userlist_winonload = window.onload;	
	window.onload = function(){
		userlist_winonload();//window onload를 여러번 사용하기 위함
		firebase.database().ref('/rooms/'+roomid+'/users').on("value",function(snapshot){
			erasetouserlist();
		  	userlist = snapshot.val();
		  	userreadycount=0;
		  	
		  	var gamehost_exist=false;
		  	
			for(var key in userlist){
				var user = 	userlist[key];
				
				user.ready ? userreadycount++ : 0;
				
				if(gamehostid!=null && user.user_id==gamehostid ){//만약 userlist의 status가 host면 그대로 표시
					
// 					pushtouserlist(user.user_nick+' / 방장');
					$("#ingame_userlist").append(make_hostdiv(user.user_nick,user.user_id));
					
					if(user.status!="host"){
						firebase.database().ref('rooms/'+roomid+'/users/'+userstatusRef.key).update({
							status : "host"
					  	});
					}
					gamehost_exist=true;

				}else{
					var userdata=user.user_nick+' / '+ (user.ready ? '준비완료':'대기중');
					
					$("#ingame_userlist").append(make_memberdiv(user.user_nick,user.ready,user.user_id,key));
// 					pushtouserlist(userdata);	
				}
		  	};
		  	
		  	if(userlist!=null){
		  		gamehost_manager(userlist,gamehost_exist);
		  	}
		  	
		  });
	}
	
	function make_hostdiv(hostnick,hostid){
		var hostref="";
		hostref+="<div class=\"user-box\">";
		hostref+="<img src=\"img/sub_gameroom/user.png\" class=\"user-img\">";
		hostref+="<div class=\"user-nick\">";
		hostref+=hostnick;
		hostref+="</div>";
		hostref+="<div id=\""+hostid+"-talkballon\" class=\"sub visibie-hidden\"></div>";
		hostref+="<img src=\"img/sub_gameroom/crown.png\" class=\"user-crown\"></div>";
		
		return hostref; 
	}
	
	function make_memberdiv(nick,ready,id,key){
		var memberref="";
		memberref+=	gamehost_isme ? "<div class=\"user-box-clickable\" onclick=\"manage_member('"+nick+"','"+id+"','"+key+"')\">" : "<div class=\"user-box\">";
		memberref+="<img src=\"img/sub_gameroom/user.png\" class=\"user-img\">";
		memberref+="<div class=\"user-nick\">";
		memberref+=nick;
		memberref+="</div>";
		memberref+="<div id=\""+id+"-talkballon\" class=\"sub visibie-hidden\"></div>";
		if(ready) memberref+="<img src=\"img/sub_gameroom/ready.svg\" class=\"user-ready\">";
		memberref+="</div>";
		
		return memberref;
	}

	function erasetouserlist(){
		$("#ingame_userlist").html("");
	}
	
	function pushtouserlist(txt){
		$("#ingame_userlist").append(txt);
	}
	
	async function getmyroomuserdata(){
		var value;
	
		await firebase.database().ref('rooms/'+roomid+'/users/'+userstatusRef.key).once('value').then(function(snapshot){
			value = snapshot.val();
		});
		return value;
	}
	async function getuserlist(){
		var value;
		await firebase.database().ref('/rooms/' + roomid+'/users').once('value').then(function(snapshot){
			value= snapshot.val();
		});
		return value;
	} 

	async function gamehost_manager(userlist,gamehost_exist){
		  var roomhost;
	
		  //user 대기목록 나혼자일때
		  if(Object.keys(userlist).length==1 && !gamehost_exist){		  	
		  	var hostid_local;
		  	await gethostid().then(result => hostid_local = result);
				
			if(hostid_local!=userid){
				
				setTimeout(async function(){
					var local_userlist;
					
					await getuserlist().then(result => local_userlist = result); //settimeout의 시간이 지난뒤 userlist를 가져옴
					
					//1인혼자 남은 인원의 id랑 setting의 gamehost의 id가 같지 않다면 setting의 gamehostid를 1인의 id로 수정
					
					await gethostid().then(result => hostid_local = result);

					if(local_userlist!=null && Object.keys(local_userlist).length==1 && hostid_local!=userid){
					
							
						//host값을 신경써야되서 봐야함
						await firebase.database().ref('rooms/'+roomid+'/setting').update({
							gamehostid : userid
					  	});
						
						await firebase.database().ref('rooms/'+roomid+'/users/'+userstatusRef.key).update({
							status : "host"
					  	});
						
					}
				},1500);
			}
			
			// rooms에  hostid가 있고 
			// member중에 host인 사람의 id가 있는데 
			// host value가 아닐때 hostvalue로 바꿔줌
		  }else if(Object.keys(userlist).length==1 && !gamehost_exist){
			  console.log("oneman and no gamehost");
		  
			  var hostid;
			  await gethostid().then(result => hostid = result);
			  if(userid==hostid){
				firebase.database().ref('rooms/'+roomid+'/users/'+userstatusRef.key).update({
					status : "host"
				});
			  }
			//rooms ingame에 사람은 1명이상이고  gamehost는 존재하지않을때 새로운 host지정
		  }else if(Object.keys(userlist).length > 1 && !gamehost_exist){
			setTimeout(async function(){
				
			  	var local_userlist,local_gamehostid;
			  	var local_gamehostexist=false;
			  	
				await getuserlist().then(result => local_userlist = result); //settimeout의 시간이 지난뒤 userlist를 가져옴
				if(local_userlist==null) return;
				
				await gethostid().then(result => local_gamehostid = result);
				
				var spare_host;
				for (var key in local_userlist) {
					var user = 	local_userlist[key];
					
					if(local_gamehostid==user.user_id){
						local_gamehostexist= true;
						break;
					}else{
						if(spare_host==null) spare_host=user;
						else if(spare_host.connect_time > user.connect_time) spare_host=user; 
					}
					
				}
	
				if(!local_gamehostexist && spare_host!=null && userid == spare_host.user_id){
					
					//host값을 신경써야되서 봐야함
					await firebase.database().ref('rooms/'+roomid+'/setting').update({
						gamehostid : userid
				  	});
					
					await firebase.database().ref('rooms/'+roomid+'/users/'+userstatusRef.key).update({
						status : "host"
				  	});
				}
				
				
			},2000);
			  
		  }else{
// 			  console.log("else",gamehost_exist);
		  }		
		  
	}

//userlist related javascript end
</script>

<script>
// room & game setting related javascript start
	var rngsetting_winonload = window.onload;	
	window.onload = function(){
		rngsetting_winonload();//window onload를 여러번 사용하기 위함
		//호스트 바꿔주는 리스너메서드 
		firebase.database().ref("rooms/"+roomid+"/setting/gamehostid").on("value",async function(snapshot){
			gamehost_isme = snapshot.val() == userid ? true : false;
			showroomsetting_btn(gamehost_isme);

			if(gamehost_isme){
				setsettinggamehostnick();
				setstartbtn_host();
				await getgamegenre();//게임장르를 가져옴
				await setmereadyfalse();
			}else{
				setstartbtn_member();
				ifmymbr_statusishost();
			}
			
			gamehostid=snapshot.val();
		});
		

		//방제 바꿔주는 리스너메서드 
		 firebase.database().ref("rooms/"+roomid+"/setting").on("value",function(snapshot){
			 $('#gameroom-title').text("방제 : " +snapshot.val().roomName);
			 
			 //모달창의 방제 이름
			 $('#modal_roomname').val(snapshot.val().roomName);
			 
			 //모달창의 회원수제한
			 $('#modal_limitofmember').val(snapshot.val().limitofmember).prop("selected", true);
			 
			 //모달창의 게임라운드
			 $('#modal_gameround').val(snapshot.val().gameround).prop("selected", true);
			 
			 //모달창의 시간제한
			 $('#modal_limitoftime').val(snapshot.val().time_limit).prop("selected", true);
			 
			//모달창의 게임 잠금 유무
			snapshot.val().lock ? $('#makeroom_lockvalue').prop("checked", true) : $('#makeroom_lockvalue').prop("checked", false);
			
			//모달창의 잠금 패스워드
			snapshot.val().lock ? $('#makeroom_lockpassword').val(snapshot.val().lock_password) : $('#makeroom_lockpassword').val("");   
// 			 $('#makeroom_lockpassword').val(snapshot.val().lock_password);
		  });
		
		function setsettinggamehostnick(){
			firebase.database().ref('rooms/'+roomid+'/setting/').update({
				gamehostnick : user_nick
			});
		}
		
		async function setmereadyfalse(){
				if(user_readybool) user_ready();
		}
		
		function setstartbtn_host(){
			$("#usrready_button_div").html("<button id=\"hoststart_button\" onclick=\"gamestart()\" class=\"ready-button\">게임시작</button>");
		}
		
		function setstartbtn_member(){
			$("#usrready_button_div").html("<button id=\"usrready_button\" onclick=\"user_ready()\" class=\"ready-button\">준비</button>");
		}
		
		function showroomsetting_btn(hostvalue){
			hostvalue ? $("#room_settingtool").css("visibility","visible") : $("#room_settingtool").css("visibility","hidden");
		}
	}
	
	async function ifmymbr_statusishost(){
		
// 		console.log("hi!");
		var status;
		if(gamehost_isme) return;
// 		console.log("userstatusRef.key",userstatusRef.key);
		await firebase.database().ref('rooms/'+roomid+'/users/'+userstatusRef_key).once('value').then(function(snapshot){
// 			console.log("snapshot.val()",snapshot.val());
			if(snapshot.val()==null) return;
			status = snapshot.val().status;
		});
		
		if(status=="host"){
			await firebase.database().ref('rooms/'+roomid+'/users/'+userstatusRef_key).update({
				status : "member"
		  	});
		}
	}
	
	
	
	var conn_status =localStorage.getItem("connect_status");
// 	if(conn_status==null||conn_status=="unload"){
// 		localStorage.setItem("connect_status","gameroom");
// 	}else if(conn_status=="gameroom"){
// 		alert("중복접속 방지");
// 		location.href="Main_lobby.html";
// 	}
	
// 	window.onbeforeunload = async function(e) {		
// 		//kickout상태면 onbeforeunload fuction을 활용안하고 바로 대기실로

// 		await localStorage.setItem("connect_status","unload");
// 		var kick_out;
// 		var dialogText="123";
// // 		e.returnValue = dialogText;
// // 	    return dialogText;
		
// 	};
	
	// room & game setting related javascript end
</script>



<script>
//chatting related javascript start
	var chatting_winonload = window.onload;
	window.onload = function(){
		chatting_winonload();//window onload를 두번 사용하기 위함
		
		var talkballonobj={};
		
		firebase.database().ref("rooms/"+roomid+"/chatting").on("value",function(snapshot){
			if(snapshot.val()==null) return;
			
			var mycolor="";
			if(snapshot.val().chat_user_id==userid){
				mycolor="mycolor";
			}
			
			$("#chat-item").append("<div class=\"chat-head ellipse "+mycolor+"\">"+snapshot.val().chat_user_nick+"</div>");
			$("#chat-item").append("<div class=\"chat-body "+mycolor+"\">"+snapshot.val().chatcontent+"</div>");
			$("#chat-item").append("<div class=\"chat-stamp "+mycolor+"\">"+gettime()+"</div>");
			
			$("#chat-item-box").scrollTop($("#chat-item-box")[0].scrollHeight);
			
			var userid_local= "#"+snapshot.val().chat_user_id+"-talkballon";
			var chat_content_local = snapshot.val().chat_user_nick+" : "+snapshot.val().chatcontent;
			$(userid_local).css("visibility","visible");
			$(userid_local).text(chat_content_local);
			
			//말풍선 시간지나면 사라지기 
			clearTimeout(talkballonobj[snapshot.val().chat_user_id]);//it's work!
			talkballonobj[snapshot.val().chat_user_id] = setTimeout(function(){
				$(userid_local).css("visibility","hidden");
			},2000);
		
		});
	}

	function enterkey() {
	    if (window.event.keyCode == 13) {
	    	userchatting();
	    }
	}
	
	function userchatting(){
		var userchatting = $('#usermsg_inputbox').val();
		
		if(userchatting==null||userchatting=="")return;
		$('#usermsg_inputbox').val('');
		
		//save in database
		firebase.database().ref("rooms/"+roomid+"/chatting").set({
			"chatcontent" : userchatting,
			"chat_user_nick" : user_nick,
			"chat_user_id" : userid
		});
		
		firebase.database().ref("rooms/"+roomid+"/chatting").set({
		});
		
		if(ongame_status=="answer_trying"){//만약 게임이 시작되서 answer_trying의 경우
			userchatting=replaceAll(userchatting.toUpperCase()," ","");//모두 대문자로 처리하고 백스페이스 공간지움
			firebase.database().ref("rooms/"+roomid+"/ongame_answertrying").set({
				"user_answer" : userchatting,
				"user_nick" : user_nick,
				"user_id" : userid
			});	
		}
	}
	
	function gettime(){
		let today = new Date();   
	
		let hours = today.getHours();	   // 시
		let minutes = today.getMinutes();  // 분
		let seconds = today.getSeconds();  // 초
		let ampm="";
		if(hours>12){
			hours-=12;
			ampm="오후";
		}else{
			ampm="오전";
		}
		 
		minutes = minutes.toString().length==1 ? "0"+minutes : minutes;
		seconds = seconds.toString().length==1 ? "0"+seconds : seconds;
		
		return ampm+" "+hours+":"+minutes+":"+seconds;
	}
//chatting related javascript end
</script>

<script>
//userstatus related javascript start
//ingame user handler

	
	function user_ready(){
		if(!user_readybool){
			$('#usrready_button').text('준비취소');
			user_readybool = true;
			setuserreadystatus(true);
		}else{
			$('#usrready_button').text('준비');
			user_readybool = false;
			setuserreadystatus(false);
		}
	}
	
	function setuserreadystatus(readybool){
		var userstatus_key = localStorage.getItem('userstatusRef_key');
		firebase.database().ref('/rooms/'+roomid+'/users/'+userstatus_key).update({
			ready : readybool
		});
	}

//userstatus related javascript end
</script>


<script>
//modal related javascript start
var modal_winonload = window.onload;	
window.onload = function(){
	modal_winonload();//window onload를 여러번 사용하기 위함
					
	}
	
	function makeroom_roomsetting(){
		$("#roomSetting").modal();
	}
	
	function gameroomsetting(){
		var roomName = $("#modal_roomname").val();
		
		if(roomName==null||roomName==""){
			alert("방이름을 입력하셔야합니다.");
			$("#modal_roomname").focus();
			return;
		}
		
		var is_lock = $("#makeroom_lockvalue").is(":checked");
		var lockpassword = $("#makeroom_lockpassword").val();
		if(is_lock && (lockpassword==null || lockpassword=="")){
			alert("비밀번호를 입력해주세요.");
			$("#makeroom_lockpassword").focus();
			return;
		}
		 
		//save in database
		firebase.database().ref('rooms/'+roomid+'/setting').update({
			"roomName" : $("#modal_roomname").val(),
			"limitofmember" : $("#modal_limitofmember").val(),
			"gameround" : $("#modal_gameround").val(),
			"time_limit" : $("#modal_limitoftime").val(),
			"lock":$("#makeroom_lockvalue").is(":checked"),
			"lock_password":$("#makeroom_lockpassword").val()
	 	});
		$("#roomSetting").modal("hide");
	
	}
//userlist related javascript end
</script>

<script>
//game progress related javascript start
	function gamestart(){
		if(!gamehost_isme){
			alert("방장이 아닙니다.");
			return;
		}
		
		if(Object.keys(userlist).length-1 <= userreadycount&&ongame_status=="waiting_status"){
			gamestatusupdate("gamestart");
		}else{
			 alert("준비되지 않은 플레이어가 있습니다.");
			 return;
		}
	}
	
	var game_progress_winonload = window.onload;	
	window.onload = function(){
		game_progress_winonload();//window onload를 여러번 사용하기 위함
		
		//퀴즈장르를 가져와서 arr에 저장
// 		firebase.database().ref("quizgenre").on("child_added",function(snapshot){
// 		 	quizgenre_arr.push(snapshot.key);
// 		});
		
		firebase.database().ref('/rooms/'+roomid+'/syschat').on("value",async function(snapshot){ //시스템 메세지 리스너
			if(snapshot.val()==null) return;
			
			var system_chatfont="system-chatfont";
	  		$("#chat-item").append("<div class=\"chat-head ellipse "+system_chatfont+"\">[[  system  ]]</div>");
			$("#chat-item").append("<div class=\"chat-body "+system_chatfont+"\">"+snapshot.val().system_msg+"</div>");
			$("#chat-item").append("<div class=\"chat-stamp mycolor\">"+gettime()+"</div>");
			$("#chat-item-box").scrollTop($("#chat-item-box")[0].scrollHeight);
			
		});
		
		
		firebase.database().ref('/rooms/'+roomid+'/ongame').on("value",async function(snapshot){
				
			ongame_status=snapshot.val().gamestatus;
			
			if(!gamehost_isme) return;//방장아니면 게임진행상황에 관여못함
	  		switch (snapshot.val().gamestatus) {
				case "gamestart":
					erasetochat();
					pushto_syschat("게임이 시작되었습니다.");
					
					//방장만 퀴즈 바꿀수 있게 함
					if(gamehost_isme){
						setTimeout(async function(){
							await progressround_setzero();
							gamestatusupdate("newquiz");
						},2000);//2초뒤에 새퀴즈시작
					}
					break;
					
				case "newquiz":
					pushto_syschat("문제를 맞춰주세요.");
// 					sysgame_alert("문제를 맞춰주세요.");
					if(gamehost_isme){
						pushtoquiz_toserver();//문제를 랜덤으로 뽑아서 해당 room의 ongame_quiz에 넣음
					}
					break;
				
				case "answer_trying":
					if(gamehost_isme){
						var timelimit;
						await get_timelimit().then(result=>timelimit =result);
						
						anstry_Interval = setInterval(async function() {
	
							if( 0 < timelimit && --timelimit <= 5){
// 								system_msg(timelimit+"초 남았습니다");
								sec_left_reminder(timelimit);
		
							}else if(timelimit<=1){
								clearTimeout(anstry_Interval);
								
// 								system_msg("아무도 맞추지 못했습니다.");
								sysgame_alert("아무도 맞추지 못했습니다.");

								gamestatusupdate("no_answer");
								
								setTimeout(function(){
									gamestatusupdate("one_round_end");
								},2000);
							}
	                    },1000);
					}
					break;
					
				case "rightanswer":
					
					erasetochat();
					clearTimeout(anstry_Interval);//정답을 맞췃을경우 interval취소
					
					firebase.database().ref('/rooms/'+roomid+'/ongame_answertrying').once("value",function(snapshot){
						sysgame_alert(snapshot.val().user_nick+"님 정답입니다.");
						pushto_syschat("정답입니다.")
					});
					
// 					await whatisanswer();
					
					//여기서 게임라운드 진행value랑 게임라운드 value랑 비교하는 메서드
					
					if(gamehost_isme){
						setTimeout(function(){
							gamestatusupdate("one_round_end");
						},2000);
					}
					answer_arr=null;
					break;
				case "one_round_end":
					
					//progressround를 한라운드올리는 메서드
					await gameprogress_stepup();
					ongame_anstry_reset(); //room db 의 answer_try를 리셋
					
					var gameremaing_count;
					await gameremaing_progressnum().then(result => gameremaing_count=result);
					
					if(gameremaing_count>0){
						gamestatusupdate("newquiz");
					}else if(gameremaing_count<=0){
						gamestatusupdate("game_end");
					}else{
						console.log("roundelse default")
					}					
					break;
				case "game_end":
					pushto_syschat("게임이 끝났습니다.");
					if(gamehost_isme) {						
						quiz_reset();//room db의 quiz내용을 없앰
						await scorerecord_touser();//상대방에게 점수를 매기는 메서드
						await gamescore_reset();//게임진행상황동안 생겻던 점수 레코드 초기화
						setTimeout(function(){
							gamestatusupdate("waiting_status");//대기상태로 돌림
						},2000);
					}
					
					break;
					
				default:
// 					console.log("125");
					break;
				}
				 
		});
		
		
		firebase.database().ref('/rooms/'+roomid+'/ongame_answertrying').on("value",function(snapshot){
			
			if(gamehost_isme && ongame_status=="answer_trying" && answer_arr!=null){
				for(var key in answer_arr){
					if(snapshot.val().user_answer==answer_arr[key]){
						game_scoreup(snapshot.val());
						gamestatusupdate("rightanswer");
						return;
					}
				}
				system_msg("틀렸습니다.")
			}
		});
		
		firebase.database().ref('/rooms/'+roomid+'/ongame_quiz').on("value",function(snapshot){
			if(snapshot.val()!=null){
				$('#content-genre').text("장르 : "+snapshot.val().quizgenre);
				$('#content-quiz').text("문제 내용 : "+snapshot.val().quiz);
			}else{
				$('#content-genre').text("");
				$('#content-quiz').text("");
			}
			if(gamehost_isme && ongame_status=="answer_trying"){
				answer_arr = snapshot.val().quizanswer_array;
			}
		});
		
		var limitbox_int;
		firebase.database().ref('/rooms/'+roomid+'/ongame_sysalert/left_time').on("value",async function(snapshot){
			if(snapshot.val()==null) return;
			$("#limit-timebox").css("visibility","visible");
			$("#limit-time-rightbox").text(snapshot.val().left_time+"초");
			
			clearTimeout(limitbox_int);
			limitbox_int = setTimeout(function(){
				$("#limit-timebox").css("visibility","hidden");
			},1000);			
		});
		
	}
	var t1;
	async function scorerecord_touser(){
		if(!gamehost_isme) return;
		var userrecords;
		await firebase.database().ref('/rooms/'+roomid+'/gamescore').once('value').then(function(snapshot){
			if(snapshot.val()==null)return;
			userrecords=snapshot.val();
		});
		
		if(userrecords==null)return;
		var scr_rcrd_array = Object.entries(userrecords);
		//정렬
		for(var i =0; i < scr_rcrd_array.length;i++){
			for (var i2 = i+1; i2 > scr_rcrd_array.length; i2++) {
				if(scr_rcrd_array[i][1].winscore > scr_rcrd_array[i2][1].winscore){
					var tmp=scr_rcrd_array[i2];
					scr_rcrd_array[i2]=scr_rcrd_array[i];
					scr_rcrd_array[i]=tmp;
				}
			}
		}
		
// 		console.log(scr_rcrd_array);
		//등수구하기
		for (var i = 0; i < scr_rcrd_array.length; i++) {
			var rank=i+1;
			scr_rcrd_array[i][1].rank=rank;
			
			for(var i2 = i+1; i2 < scr_rcrd_array.length; i2++) {
				
				if(scr_rcrd_array[i][1].winscore == scr_rcrd_array[i2][1].winscore){
					scr_rcrd_array[i2][1].rank=rank;
					i++;
				}else{
					break;
				}
			}
		}
		console.log("scr_rcrd_array",scr_rcrd_array);
	}
	
	async function gamescore_reset(){
		if(!gamehost_isme) return;
		await firebase.database().ref('/rooms/'+roomid+'/gamescore').set({
			
		});
	}
	
	async function game_scoreup(wnr_inform){
		if(!gamehost_isme) return;
		
		var user_score_local;
		await firebase.database().ref('/rooms/'+roomid+'/gamescore/'+wnr_inform.user_id+"/winscore").once('value').then(function(snapshot){
			user_score_local =snapshot.val()==null ? 0 : snapshot.val();
		});
		
		await firebase.database().ref('/rooms/'+roomid+'/gamescore/'+wnr_inform.user_id).update({
			winscore : user_score_local+10
		});
	}
	
	function ongame_anstry_reset(){
		if(!gamehost_isme) return;
		firebase.database().ref('/rooms/'+roomid+'/ongame_answertrying').set({
		
		});
	}
	
	function quiz_reset(){
		if(!gamehost_isme) return;
		firebase.database().ref('/rooms/'+roomid+'/ongame_quiz').set({
		});
	}
	
  	function gamestatusupdate(update_value){
  		if(gamehost_isme){
  			firebase.database().ref('/rooms/'+roomid+'/ongame').update({
				gamestatus : update_value
			});
  		}
  	}
  	
  	function erasetochat(){
//   		document.getElementById("chatcontent").innerHTML="";
  	}
  	
  	function pushto_syschat(txt){
		if(!gamehost_isme)return;
		firebase.database().ref('/rooms/'+roomid+'/syschat').update({
			system_msg : txt
			
		});
		
		firebase.database().ref('/rooms/'+roomid+'/syschat').set({
			
		});
  	}
  	
    async function progressround_setzero(){
  		await firebase.database().ref('rooms/'+roomid+'/setting').update({
  			gameround_progress : 0
  	  	});
    }
    
  	async function get_timelimit(){//게임진행도 한단계업 메서드
		
		var time;
		
		await firebase.database().ref('rooms/'+roomid+'/setting/time_limit').once('value').then(function(snapshot){
			time = snapshot.val() != null ? snapshot.val() : 0;
		});
		
		return time;
		
	}
  	
	function system_msg(msg,color){
		if(!gamehost_isme) return;
		if(color==null) color='black';
		firebase.database().ref('/rooms/'+roomid+'/system').update({
			system_msg : msg,
			system_msgcolor : color
		});
		
		firebase.database().ref('/rooms/'+roomid+'/system').set({
			
		});
	}
	
	async function sysgame_alert(txt){
		if(!gamehost_isme) return;		
		
		var sysmsg_whtisans_local;
		await whatisanswer().then(result => sysmsg_whtisans_local=result);
		
		firebase.database().ref('/rooms/'+roomid+'/sysmsg_altwin').update({
			sysmsg_alertcontent : txt,
			sysmsg_whtisans : sysmsg_whtisans_local
		});
		
		firebase.database().ref('/rooms/'+roomid+'/sysmsg_altwin').set({
			
		});
		
	}
	
  	async function whatisanswer(){
  		var answer;
  		await firebase.database().ref('/rooms/'+roomid+'/ongame_quiz/quizanswer_orig').once("value",function(snapshot){
// 			system_msg("\n정답은 「"+snapshot.val()+"」 입니다.");
// 			$("#sysmsg-whtisans").text("\n정답은 「"+snapshot.val()+"」 입니다.");
			answer=snapshot.val();
		});
  		return answer;
  		
  	}
  	
 	async function gameprogress_stepup(){//게임진행도 한단계업 메서드
		
		var gameroundprogress_value;
		
		await firebase.database().ref('rooms/'+roomid+'/setting/gameround_progress').once('value').then(function(snapshot){
			gameroundprogress_value = snapshot.val() != null ? snapshot.val() : 0;
		});
		
		++gameroundprogress_value;
		
		await firebase.database().ref('rooms/'+roomid+'/setting').update({
			gameround_progress : gameroundprogress_value
	  	});
	}
    
 	
	async function gameremaing_progressnum(){
		var gameround_value;
		var gameroundprogress_value;

		await firebase.database().ref('rooms/'+roomid+'/setting/gameround').once('value').then(function(snapshot){
			gameround_value = snapshot.val()!=null ? snapshot.val() : 0;
		});
		
		await firebase.database().ref('rooms/'+roomid+'/setting/gameround_progress').once('value').then(function(snapshot){
			gameroundprogress_value = snapshot.val() != null ? snapshot.val() : 0;
		});
		
		return gameround_value-gameroundprogress_value;
	}
	
	async function pushtoquiz_toserver(){
		if(!gamehost_isme) return;
		var genreindex = parseInt(Math.random()*(quizgenre_arr.length));//퀴즈장르의 배열의 숫자중 랜덤으로 하나의 숫자를 가져옴
	 	
	 	//하나의 숫자로 장르의 이름을 가져와서 데이터베이스에 삽입
	 	await firebase.database().ref('/rooms/'+roomid+'/ongame_quiz').update({
			quizgenre : quizgenre_arr[genreindex]
	  	});
		
		var quiznans = new Array();
		await firebase.database().ref("quizgenre/"+quizgenre_arr[genreindex]).on("child_added",function(snapshot){
			quiznans.push(snapshot.val());
		});
		
		var quizindex = parseInt(Math.random()*(quiznans.length));
		quiznansitem = quiznans[quizindex];
		
		await gamestatusupdate("answer_trying");
		
		await firebase.database().ref('/rooms/'+roomid+'/ongame_quiz').update({
			quiz : quiznansitem.quiz,
			quizanswer_array : quiznansitem.answer_array,
			quizanswer_orig : quiznansitem.answer_orig
	  	});
		
	}
	
	function deletechat(){
//   		if(gamehost_isme)
//   			firebase.database().ref("rooms/"+roomid+"/chatting").remove();
  	}
	
	async function sec_left_reminder(txt){
		await firebase.database().ref('/rooms/'+roomid+'/ongame_sysalert/left_time').update({
			left_time : txt,
	  	});
		
		await firebase.database().ref('/rooms/'+roomid+'/ongame_sysalert/left_time').set({
	  	});
	}
	
	async function getgamegenre(){
		//퀴즈장르를 가져와서 arr에 저장
		quizgenre_arr=new Array();
		await firebase.database().ref("quizgenre").on("value",function(snapshot){
// 		 	quizgenre_arr.push(snapshot.val().key);
		 	for(key in snapshot.val()){
		 		quizgenre_arr.push(key);
		 	}
		});
	}
  	
//game progress related javascript end
</script>

<script>
	//system related javascript start
	var system_winonload = window.onload;
	window.onload = function(){
		system_winonload();//window onload를 여러번 사용하기 위함
		//시스템 메시지 리스너
		firebase.database().ref("rooms/"+roomid+"/system").on("value",function(snapshot){
			if(snapshot.val()==null) return;
			pushtosystem(snapshot.val().system_msg,snapshot.val().system_msgcolor);
		});
		
		firebase.database().ref('/rooms/'+roomid+'/sysmsg_altwin').on("value",function(snapshot){
			if(snapshot.val()==null) return;
	 		$("#sysmsg-alertcontent").text(snapshot.val().sysmsg_alertcontent);
	 		$("#sysmsg-whtisans").text("정답은 「"+snapshot.val().sysmsg_whtisans+"」 입니다.");
	 		
	 		$("#sysmsg").css("visibility","visible");
	 		setTimeout(function(){$("#sysmsg").css("visibility","hidden")},1500);
		});
		
		function pushtosystem(txt,color){
			if(color==null) color="black";
			pushto_syschat(txt)
// 			document.getElementById("chatcontent").innerHTML+='<span style=\"color:'+color+'\">'+txt+'</span><br>';
// 			$("#chatroom").scrollTop($("#chatroom")[0].scrollHeight);
		}
	}	 
	//system related javascript end
</script>

</html>

