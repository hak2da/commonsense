<!DOCTYPE html>
<html>
<head>

<link rel="shortcut icon" href="img/icon/brain.png">

<!-- Animate.css -->
<link rel="stylesheet" href="css/animate.css">
<!-- Icomoon Icon Fonts-->
<link rel="stylesheet" href="css/icomoon.css">
<!-- Bootstrap  -->
<link rel="stylesheet" href="css/bootstrap.css">


<!-- Theme style  -->
	<link rel="stylesheet" href="css/bootstrapmin.css">
	
	<link rel="stylesheet" href="css/Main_page/react_button.css">
	
	<link rel="stylesheet" href="css/common/react_style.css">
	
<!-- commonsense common.css -->
	<link rel="stylesheet" href="css/common/common.css">

 <!-- jQuery -->
	<script src="js/jquery.min.js"></script>
	<!-- jQuery Easing -->
	<script src="js/jquery.easing.1.3.js"></script>
	<!-- Bootstrap -->
	<script src="js/bootstrap.min.js"></script>
	<!-- Waypoints -->
	<script src="js/jquery.waypoints.min.js"></script>
	<!-- Main -->	
	<script src="js/main.js"></script>
	<!-- The core Firebase JS SDK is always required and must be listed first -->
	<script src="https://www.gstatic.com/firebasejs/7.16.0/firebase-app.js"></script>
	
	<!-- include firebase database -->
	<script src="https://www.gstatic.com/firebasejs/7.16.0/firebase-database.js"></script>
	
	<!-- include commonsense firebase reference javascript -->
	<script src="js/firebase_initiate/firebase_initiate.js"></script>

<meta charset="UTF-8">
<title>브레인 피지컬-메인 로비</title>
</head>
<body>
<div id="wrapper">
	<div id="menu-wrapper" style="height:100px;">
		<div class="head-left"> 
			<a href="Main_lobby.html"> 
				<img src="img/Main_page/brain-physical-tp2.png" style="width:80%;margin-bottom:3%;"/>
			</a>
			
		</div>
		<div class="head-right"> 
			<div style="margin-top:5%;">
				<font id="user_nickname"></font>
				<button style="border-radius:7px; color:black;width:15%;height:40px;border:0;outline:0;" onclick="nick_change()">닉변</button>
			</div>
		</div>
		
		
	
	</div>

<div>
	<div id="divleft" style="width:20%;height:500px;float:left">
	</div>
	<div style="width:60%;float:left">

		<div class="section">
		  <div class="section__item">
		    <a href="javascript:makeroom_roomsetting();" class="r-link link outlined-text link5">
			      <span class="link__label outlined-text__label">
					   <img src="img/Main_page/door.png" style="width:80px;height:80px; vertical-align:middle;" />
					   <font style="vertical-align:middle;font-size:30px;">&nbsp;방만들기</font>
			      </span>  
		    </a>
		  </div>
		</div>
		<div class="section">
		  <div class="section__item">
		    <a href="Sub_waitingroom.html" class="r-link link outlined-text link6">
		      <span class="link__label outlined-text__label">
				 <img src="img/Main_page/search.png" style="width:65px;height:65px;margin:5px; vertical-align:middle;" />
			     <font style="vertical-align:middle;font-size:30px;"> &nbsp;게임찾기</font>
		     </span>
		    </a>
		  </div>
		</div>
		<div class="section">
		  <div class="section__item">
		    <a href="Sub_ranklist.html" class="r-link link link_padding-bottom link3">
		      <span class="link__label">
		      	<img src="img/Main_page/ranking.png" style="width:65px;height:65px; margin-bottom:10px;vertical-align:middle;" />
			    <font style="vertical-align:middle;font-size:30px;">&nbsp;랭킹보기</font>
		      </span>
		    </a>
		  </div>
		</div>
	
	</div>
	<div id="divright" style="width:20%;height:500px;float:left">
	</div>
</div>
</div>

<!-- Modal -->
  <!-- 방만들기 설정값 -->
  <div  class="modal fade" id="roomSetting" role="dialog">
    <div class="modal-dialog">
    
      <!-- Modal content-->
      <div style="width:400px;margin-left:40%; margin-top:8%; vertical-align:middle;" class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h3 style="font-weight: bold;text-align:center;" class="modal-title">방 설정</h3>
        </div>
        <div class="modal-body">
          
				제목 <input id="modal_roomname" type="text" value="" maxlength="10">
				
				<br><br>				
				게임 인원 &nbsp;
				<select name="member" id="modal_limitofmember">
					<option value="4"> 4</option>
					<option value="5"> 5</option>
					<option value="6"> 6</option>
					<option value="7"> 7</option>
					<option value="8"> 8</option>
				</select>					
				
				<br><br>
				게임 라운드 &nbsp;
				<select name="round" id="modal_gameround">
					<option value="3"> 3</option>
					<option value="5"> 5</option>
					<option value="7"> 7</option>
				</select>
				
				<br><br>
				제한 시간 &nbsp;
				<select name="time" id="modal_limitoftime">
					<option value="5"> 5</option>
					<option value="7"> 7</option>
					<option value="9"> 9</option>
				</select>
				
<!-- 				<br><br> -->
<!-- 				<input type="radio" name="group" checked="">개인전 -->
<!-- 				<input type="radio" name="group">팀전 -->
				
				<br><br>
				
				<input type="checkbox" name="chk_info" value="HTML" id="makeroom_lockvalue">잠금설정
				<input type="text" value=""  placeholder="Enter password..." id="makeroom_lockpassword">
				
				<br><br>
        </div>
        <div class="modal-footer">
       		<button type="button" class="btn btn-default"  onclick="makeroom_makeroom()">확인</button>
          	<button type="button" class="btn btn-default" data-dismiss="modal">취소</button>
        </div>
      </div>
      
    </div>
  </div>

<!-- 닉 변경 설정값 -->
  <div  class="modal fade" id="nickchange_modal" role="dialog">
    <div class="modal-dialog">
    
      <!-- Modal content-->
      <div style="width:400px;margin-left:40%; margin-top:8%; vertical-align:middle;" class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h3 style="font-weight: bold;text-align:center;" class="modal-title">닉네임 설정</h3>
        </div>
        <div class="modal-body">
          
				닉네임 <input id="modal_nickname" type="text" value="" maxlength="10">

        </div>
        <div class="modal-footer">
       		<button type="button" class="btn btn-default" onclick="nick_change_confirm()">확인</button>
			<!--<button type="button" class="btn btn-default" data-dismiss="modal">취소</button> -->
        </div>
      </div>
      
    </div>
  </div>

</body>
<script>
function makeroom_roomsetting(){
	$("#roomSetting").modal();
}

function randomString(ranlength) {
	var chars = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz";
	var string_length = ranlength;
	var randomstring = '';
	for (var i=0; i<string_length; i++) {
		var rnum = Math.floor(Math.random() * chars.length);
		randomstring += chars.substring(rnum,rnum+1);
	}
	//document.randform.randomfield.value = randomstring;
	return randomstring;
}

</script>


<script>

//<<<<<<<<<<<<		firebase	<<<<<<<<<<<<<<<<<
//<<<<<<<<<<<<		firebase	<<<<<<<<<<<<<<<<<
//<<<<<<<<<<<<		firebase	<<<<<<<<<<<<<<<<<
//<<<<<<<<<<<<		firebase	<<<<<<<<<<<<<<<<<	
	
	
	var ws_usernick;
	var ws_userid;
	window.onload = function(){
		
		//USER ID,NICKNAME 값을 파이어베이스에 저장할것
		
		ws_usernick = localStorage.getItem('usernick');
		ws_userid = localStorage.getItem('userid');
		
		if(ws_userid==null||ws_usernick==null){
			var usernick = "USER_"+randomString(6);
			
			var useridRef = firebase.database().ref("users/anonymous").push({
				user_nick : usernick
			});
			
			var userid = useridRef.key;
			
			localStorage.setItem('usernick', usernick);
			localStorage.setItem('userid', userid);
			
			ws_usernick = localStorage.getItem('usernick');
			ws_userid = localStorage.getItem('userid');
			
			nick_change();
			
		}else if(ws_userid != null && ws_usernick != null){
	
			firebase.database().ref("users/anonymous/"+ws_userid).on("value",function(snapshot){
				
				try{
					if(snapshot.val().user_nick!=null){
						
						$("#user_nickname").text(snapshot.val().user_nick);
						localStorage.setItem('usernick', snapshot.val().user_nick);
						ws_usernick=snapshot.val().user_nick;
						
					}else if(snapshot.val().user_nick==null&&ws_userid!=null){
						firebase.database().ref("users/anonymous/"+ws_userid).set({
							user_nick : ws_usernick
						});
						
					}else{
						alert("err");	
					}
				}catch(e){
					console.log("err",e);
					localStorage.removeItem('usernick');
					localStorage.removeItem('userid');
					location.reload(true);
				}
				
		  	});
			
		}else{
			alert("error occured!!\n when bring the user information");
			localStorage.removeItem('usernick');
			localStorage.removeItem('userid');
		}
		
		firebase.database().ref("users/anonymous/"+ws_userid).on("value",function(snapshot){
			$("#user_nickname").text(snapshot.val().user_nick);
			$("#modal_nickname").val(snapshot.val().user_nick);
	  	});
		
		// connect status 		
		// 접속 상태
	    // [START rtdb_presence]
	    // Fetch the current user's ID from Firebase Authentication.

	    var uid = ws_userid;
	    
	    // Create a reference to this user's specific status node.
	    // This is where we will store data about being online/offline.

	    var userStatusDatabaseRef = firebase.database().ref('/users/anonymous/' + uid+'/status');

	    // We'll create two constants which we will write to 
	    // the Realtime database when this device is offline
	    // or online.
	    var isOfflineForDatabase = {
	        state: 'offline',
	        last_changed: firebase.database.ServerValue.TIMESTAMP,
	    };

	    var isOnlineForDatabase = {
	        state: 'online',
	        last_changed: firebase.database.ServerValue.TIMESTAMP,
	    };

	    // Create a reference to the special '.info/connected' path in 
	    // Realtime Database. This path returns `true` when connected
	    // and `false` when disconnected.
	    firebase.database().ref('.info/connected').on('value', function(snapshot) {
	        // If we're not currently connected, don't do anything.
	        if (snapshot.val() == false) {
	            return;
	        };

	        // If we are currently connected, then use the 'onDisconnect()' 
	        // method to add a set which will only trigger once this 
	        // client has disconnected by closing the app, 
	        // losing internet, or any other means.
        	userStatusDatabaseRef.onDisconnect().set(isOfflineForDatabase).then(function() {
	            // The promise returned from .onDisconnect().set() will
	            // resolve as soon as the server acknowledges the onDisconnect() 
	            // request, NOT once we've actually disconnected:
	            // https://firebase.google.com/docs/reference/js/firebase.database.OnDisconnect

	            // We can now safely set ourselves as 'online' knowing that the
	            // server will mark us as offline once we lose connection.
	            userStatusDatabaseRef.set(isOnlineForDatabase);
	        });
	    });
	    // [END rtdb_presence]
	
	}
	
	function nick_change(){
// 		var newnick=prompt("변경할 닉네임을 입력해주세요",ws_usernick);
// 		if(newnick!=null){
// 			data = {user_nick:newnick};
// 			firebase.database().ref().child('users/anonymous/'+ws_userid).update(data);	
// 		}
		$("#nickchange_modal").modal();
		
	}
	
	function nick_change_confirm(){
		var nick_name_local = $("#modal_nickname").val().trim();
		if(nick_name_local==null||nick_name_local==""){
			alert("변경할 닉네임을 입력해주세요");
			$("#modal_nickname").focus();
			return;
		}
		data = {user_nick:nick_name_local};
		firebase.database().ref().child('users/anonymous/'+ws_userid).update(data);	
		$("#nickchange_modal").modal("hide");
	}
</script>

<script>
//makeroom related javascript start

	var makeroom_winonload = window.onload;	
	window.onload = function(){
		makeroom_winonload(); //window onload를 여러번 사용하기 위함
						
	}
	
	function makeroom_makeroom(){
	 
		var roomName = $("#modal_roomname").val();
		
		if(roomName==null||roomName==""){
			alert("방이름을 입력하셔야합니다.");
			$("#modal_roomname").focus();
			return;
		}
		
		var is_lock = $("#makeroom_lockvalue").is(":checked");
		var lockpassword = $("#makeroom_lockpassword").val();
		if(is_lock && (lockpassword==null || lockpassword=="")){
			alert("비밀번호를 입력해주세요.");
			$("#makeroom_lockpassword").focus();
			return;
		}
		 
		//save in database
		var roomref = firebase.database().ref('rooms').push({});
		
		firebase.database().ref('rooms/'+roomref.key+'/setting').update({
			"roomName" : $("#modal_roomname").val(),
			"limitofmember" : $("#modal_limitofmember").val(),			
			"gameround" : $("#modal_gameround").val(),
			"time_limit" : $("#modal_limitoftime").val(),
			"lock":$("#makeroom_lockvalue").is(":checked"),
			"lock_password":$("#makeroom_lockpassword").val()
		 	});
		
		firebase.database().ref('rooms/'+roomref.key+'/ongame').update({
			gamestatus:"waiting_status"
		});
		
		$("#roomSetting").modal("hide");
		localStorage.setItem('roomid', roomref.key);
		localStorage.setItem('connect_status', null);
		location.href="Sub_gameroom.html";
	}
	
	function modalclose(){
// 		$("#roomSetting").modal("hide");
		$("#roomName").modal("hide");

	}
	
//makeroom related javascript end
</script>

</html>

