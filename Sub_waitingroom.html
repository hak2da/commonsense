<!DOCTYPE html>
<html>
<head>


<!-- Animate.css -->
<link rel="stylesheet" href="css/animate.css">
<!-- Icomoon Icon Fonts-->
<link rel="stylesheet" href="css/icomoon.css">
<!-- Bootstrap  -->
<link rel="stylesheet" href="css/bootstrap.css">


<!-- Theme style  -->
<link rel="stylesheet" href="css/bootstrapmin.css">

<link rel="stylesheet" href="css/Main_page/react_button.css">

<link rel="stylesheet" href="css/common/react_style.css">


<!-- commonsense common.css -->
	<link rel="stylesheet" href="css/common/common.css">
<!-- commonsense common.css -->
	<link rel="stylesheet" href="css/sub_waitingroom/Sub_waitingroom.css">

 <!-- jQuery -->
	<script src="js/jquery.min.js"></script>
	<!-- jQuery Easing -->
	<script src="js/jquery.easing.1.3.js"></script>
	<!-- Bootstrap -->
	<script src="js/bootstrap.min.js"></script>
	<!-- Waypoints -->
	<script src="js/jquery.waypoints.min.js"></script>
	<!-- Main -->	
	<script src="js/main.js"></script>
	<!-- The core Firebase JS SDK is always required and must be listed first -->
	<script src="https://www.gstatic.com/firebasejs/7.16.0/firebase-app.js"></script>
	
	<!-- include firebase database -->
	<script src="https://www.gstatic.com/firebasejs/7.16.0/firebase-database.js"></script>
	
	<!-- include commonsense firebase reference javascript -->
	<script src="js/firebase_initiate/firebase_initiate.js"></script>

<meta charset="UTF-8">
<title>Insert title here</title>
</head>
<body>
<div id="wrapper">
	<div id="menu-wrapper" style="height:100px;">
		<div class="head-left">
			<a href="Main_lobby.html"> 
				<img src="img/Main_page/brain-physical-tp2.png" style="width:80%;margin-bottom:3%;"/>
			</a>
		</div>
		<div class="head-right"> 
			<div style="margin-top:5%;">
				<font id="right_usernick"></font>
			</div>
		</div>
	
	</div>

<div>
	<div id="adleft" class="adleft">
	</div>
	<div style="width:60%;float:left">
		<div id="RoomListBox" class="RoomListBox Product">
			<div style="width:20%;">
				<div class="product-title">접속자 목록</div>
				<div class="product-body leftnbottom-shadow" id="user_list">
				</div>
				
			</div>
			<div style="width:80%;height:500px;">
				<div class="product-title">방 목록</div>
				<div class="product-body leftnbottom-shadow" style="height:60%;">
				
								<span id="rooms-list"></span>
								<div class="rooms-item rooms-gaming rooms-locked">
									<div class="room-box">
										<span>titleㅎㅇ</span>
										<div class="hr-div">
											<hr class="hr-line">
										</div>
									</div>
									
									<div class="roombox-statusbox-left">
										<div class="invid-match-button">
										개인전</div>
										
										<div class="ingaming-button">
										게임중</div>
									</div>
									
									<div class="roombox-statusbox-right">
										<div class="host-status-text">
										방장:레드매실님</div>
										
										<div class="numofmember-status-text">
										방 인원:2/6</div>
									</div>
									
									<div class="participate-div">
										<button onclick="goingame();" class="participate-button">참가하기</button>
									</div>
								</div>
								
								<div class="rooms-item rooms-gaming rooms-locked">
								
								<div style="width:100%;text-align:center;font-size:20px;font-weight:600;margin-top:4%;">
								<img src="img/sub_gameroom/lock.png" style="width:8%;height:8%;"/>
								<span style="vertical-align:middle;">길게적으면?</span>
								</div>						
								<div style="width:100%;height:1px;display:flex;justify-content:center;">
									<hr style="background-color:black;width:90%;height:100%;border-top:0.5px;">
								</div>
								
									<div style="float:left;width:30%;margin-left:10%;line-height:200%;margin-top:5%; ">
										<div class="team-match-button">
										팀전</div>
										
										<div class="wating-button">
										대기중</div>
									</div>
									
									<div style="float:left;width:50%;line-height:200%;margin-top:5%; margin-right:10%;text-align:right;">
										
										<div style="margin-top:11%;width:90%;text-align:right;vertical-align:middle;
											color:black;font-weight:bold;">
										방장:레드매실님</div>
										
										<div style="margin-top:11%;width:90%;text-align:right;vertical-align:middle;
											color:black;font-weight:bold;">
										방 인원:2/6</div>
									</div>
									
									<div style="width:100%;height:40%;text-align:center;font-size:15px;font-weight:bolder;margin-top:8%;color:white;">
									
										<button class="enterdenied-button">
										<img class="enterdenied-img" src="img/sub_waitingroom/denied.png"/>
										참가불가</button>
									</div>
								</div>
								
						</div>
				<div class="product-title">채팅</div>
				<div class="product-body leftnbottom-shadow" id="chat-item-box" style="height:35%;">
					<div class="chat-item" id="chat-item">
					</div>
				</div>
				
				<input id="usermsg_inputbox" class="usermsg_inputbox" onkeyup="enterkey();" maxlength="200" autocomplete="off">
				<button class="waitroom_sendbutton" onclick="userchatting();" >전송</button>
				
			</div>
		</div>
	
	</div>
	<div id="adright" style="width:20%;height:500px;float:left">
	</div>
</div>
</div>

</body>
<script>
function goingame(){
	location.href="Sub_gameroom_design.html";
}

function makeroom_roomsetting(){
	 $("#roomSetting").modal();
}

async function enter_game(roomid){
	let limitofmember_local;
	let usersnum_local;
	let gamestatus_local;
	
	await firebase.database().ref('rooms/'+roomid+'/setting/limitofmember').once('value').then(function(snapshot){
		limitofmember_local = snapshot.val();
	});
	
	await firebase.database().ref('rooms/'+roomid+'/users').once('value').then(function(snapshot){
		usersnum_local =snapshot.val()==null ? 0 : parseInt(Object.keys(snapshot.val()).length); 
	});
	
	await firebase.database().ref('rooms/'+roomid+'/ongame/gamestatus').once('value').then(function(snapshot){
		gamestatus_local = snapshot.val();
	});
	
	if(gamestatus_local=="waiting_status"&& usersnum_local<parseInt(limitofmember_local)){
		localStorage.setItem('roomid', roomid);
		location.href="Sub_gameroom.html";	
	}else{
		alert("enter denied");	
	}
}

</script>

<script>

//<<<<<<<<<<<<		firebase	<<<<<<<<<<<<<<<<<
//<<<<<<<<<<<<		firebase	<<<<<<<<<<<<<<<<<
//<<<<<<<<<<<<		firebase	<<<<<<<<<<<<<<<<<
//<<<<<<<<<<<<		firebase	<<<<<<<<<<<<<<<<<	
	
	
	var ws_usernick;
	var ws_userid;
	window.onload = function(){
		
		//USER ID,NICKNAME 값을 파이어베이스에 저장할것
		
		ws_usernick = localStorage.getItem('usernick');
		ws_userid = localStorage.getItem('userid');
		
		if(ws_userid==null||ws_usernick==null){
			location.href="Main_lobby.html";
		}
		
		$("#right_usernick").text(ws_usernick+"님 환영합니다!");
		
		// connect status 		
		// 접속 상태
	    // [START rtdb_presence]
	    // Fetch the current user's ID from Firebase Authentication.

	    var uid = ws_userid;
	    
	    // Create a reference to this user's specific status node.
	    // This is where we will store data about being online/offline.

	    var userStatusDatabaseRef = firebase.database().ref('orig_server/waitingroom/userlist/'+ws_userid);

	    // We'll create two constants which we will write to 
	    // the Realtime database when this device is offline
	    // or online.
	    var isOfflineForDatabase = {
	    };

	    var isOnlineForDatabase = {
	        user_nick : ws_usernick
	        
	    };

	    // Create a reference to the special '.info/connected' path in 
	    // Realtime Database. This path returns `true` when connected
	    // and `false` when disconnected.
	    firebase.database().ref('.info/connected').on('value', function(snapshot) {
	        // If we're not currently connected, don't do anything.
	        if (snapshot.val() == false) {
	            return;
	        };

	        // If we are currently connected, then use the 'onDisconnect()' 
	        // method to add a set which will only trigger once this 
	        // client has disconnected by closing the app, 
	        // losing internet, or any other means.
        	userStatusDatabaseRef.onDisconnect().set(isOfflineForDatabase).then(function() {
	            // The promise returned from .onDisconnect().set() will
	            // resolve as soon as the server acknowledges the onDisconnect() 
	            // request, NOT once we've actually disconnected:
	            // https://firebase.google.com/docs/reference/js/firebase.database.OnDisconnect

	            // We can now safely set ourselves as 'online' knowing that the
	            // server will mark us as offline once we lose connection.
	            userStatusDatabaseRef.set(isOnlineForDatabase);
	        });
	    });
	    // [END rtdb_presence]
		
	}
	
	  firebase.database().ref("rooms").on("value",function(snapshot){
		  
		  let roomlist=snapshot.val();
		  $("#rooms-list").html("");
		  
		  for(key in roomlist){
			  let roomref =roomlist[key];
			  let divcont ="";
			  
			  divcont+=("<div class=\'rooms-item rooms-gaming rooms-locked\'>");
			  divcont+=("<div class=\"room-box\">");
			  divcont+=("<span>"+roomref.setting.roomName+"</span>");
			  divcont+=("<div class=\"hr-div\">");
			  divcont+=("<div class=\"hr-line\">");
			  divcont+=("</div></div></div>");
			  divcont+=("<div class=\"roombox-statusbox-left\">");
			  divcont+=("<div class=\"invid-match-button\">개인전</div>");
			  
			  let gamestatus = roomref.ongame.gamestatus=="waiting_status" ? "wating-button" :"ingaming-button"; 
			  let gamestatus_txt=roomref.ongame.gamestatus=="waiting_status" ? "대기중" : "게임중"; 
			  
			  divcont+=("<div class=\""+gamestatus+"\">"+gamestatus_txt+"</div>");
			  divcont+=("</div>");
			  divcont+=("<div class=\"roombox-statusbox-right\">");
			  divcont+=("<div class=\"host-status-text\">");
			  divcont+=("방장:"+roomref.setting.gamehostnick);
			  divcont+=("</div>");
			  divcont+=("<div class=\"numofmember-status-text\">");
			  divcont+=("방 인원:");
			  
			  let numofmember = roomref.users==null ? 0 : Object.keys(roomref.users).length;
			  let limitofmember = roomref.setting.limitofmember==null ? 0 : roomref.setting.limitofmember;
			  
			  divcont+=(numofmember+"/"+limitofmember);
			  divcont+=("</div></div>");
			  divcont+=("<div class=\"participate-div\">");
			  
			  if(gamestatus_txt=="대기중"&&parseInt(numofmember)<parseInt(limitofmember)){
				  divcont+=("<button onclick=\"enter_game('"+key+"');\" class=\"participate-button\">참가하기</button>");
			  }else{
				  divcont+=("<button class=\"enterdenied-button\">");
				  divcont+=("<img class=\"enterdenied-img\" src=\"img/sub_waitingroom/denied.png\"/>");
				  divcont+=("참가불가</button>");
			  }
			  divcont+=("</div></div>");
			  
			  $("#rooms-list").append(divcont);
		  }
	  });
	
	firebase.database().ref("orig_server/waitingroom/userlist").on("value",function(snapshot){
		  $("#user_list").html("");
		  var userlist = snapshot.val();
		  for(key in userlist){
			  $("#user_list").append("<div class=\"users-name ellipse\">"+userlist[key].user_nick+"</div>");
		  }
  	});
	
	function enterkey() {
	    if (window.event.keyCode == 13) {
	    	userchatting();
	    }
	}
	
	function userchatting(){
		var userchatting = $('#usermsg_inputbox').val();
		
		if(userchatting==null||userchatting=="")return;
		$('#usermsg_inputbox').val('');
		
		//save in database
		firebase.database().ref("orig_server/waitingroom/userchatting").set({
			"chatcontent" : userchatting,
			"chat_user_nick" : ws_usernick,
			"chat_user_id" : ws_userid
		});
		
		firebase.database().ref("orig_server/waitingroom/userchatting").set({
		});
	}
	
	firebase.database().ref("orig_server/waitingroom/userchatting").on("value",function(snapshot){
		if(snapshot.val()==null) return;
		
		var mycolor="";
		if(snapshot.val().chat_user_id==ws_userid){
			mycolor="mycolor";
		}
		
		$("#chat-item").append("<div class=\"chat-head ellipse "+mycolor+"\">"+snapshot.val().chat_user_nick+"</div>");
		$("#chat-item").append("<div class=\"chat-body "+mycolor+"\">"+snapshot.val().chatcontent+"</div>");
		$("#chat-item").append("<div class=\"chat-stamp "+mycolor+"\">"+gettime()+"</div>");
		
		$("#chat-item-box").scrollTop($("#chat-item-box")[0].scrollHeight);
	});
	
	function gettime(){
		let today = new Date();   

		let hours = today.getHours(); // 시
		let minutes = today.getMinutes();  // 분
		let seconds = today.getSeconds();  // 초
		let ampm="";
		if(hours>12){
			hours-=12;
			ampm="오후";
		}else{
			ampm="오전";
		}
		 
		minutes = minutes.toString().length==1 ? "0"+minutes : minutes;
		seconds = seconds.toString().length==1 ? "0"+seconds : seconds;
		
		return ampm+" "+hours+":"+minutes+":"+seconds;
	}
	
</script>

</html>